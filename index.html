<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WA • Cyber Monitor</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="top-bar">
        <div class="logo-area"><span>⚡</span> CYBER MON</div>
        <div class="time-display" id="clock">00:00</div>
    </header>

    <div class="container">
        <div class="stats-bar">
            <div class="stat-box">
                <span class="label">TOTAL</span>
                <span class="value" id="statTotal">0</span>
            </div>
            <div class="stat-box online">
                <span class="label">ONLINE</span>
                <span class="value" id="statActive">0</span>
            </div>
            <div class="stat-box offline">
                <span class="label">OFFLINE</span>
                <span class="value" id="statOffline">0</span>
            </div>
            <div class="stat-box">
                <span class="label">UPTIME</span>
                <span class="value" style="font-size:14px" id="statUptime">0h</span>
            </div>
        </div>

        <div class="main-controls">
            <button class="btn btn-green" onclick="openAddModal()">+ ADD BOT</button>
            <button class="btn btn-blue" onclick="startAll()">ALL ON</button>
            <button class="btn btn-red" onclick="stopAll()">ALL OFF</button>
        </div>

        <div class="section-title">> SESSION LIST</div>
        <div class="bot-grid" id="botGrid"></div>

        <div class="section-title">> TERMINAL LOGS</div>
        <div class="terminal-container">
            <div class="terminal-header">
                <div class="terminal-title" id="termTitle">NO SESSION SELECTED</div>
                <div class="terminal-actions" id="termActions" style="display:none">
                    <button onclick="controlBot('start')">START</button>
                    <button onclick="controlBot('stop')">STOP</button>
                    <button class="del" onclick="controlBot('delete')">DEL</button>
                </div>
            </div>
            <div class="terminal-logs" id="terminalLogs">
                <div style="text-align:center; padding-top:100px; color:#333;">SELECT A BOT TO VIEW LOGS</div>
            </div>
        </div>
    </div>

    <!-- ADD MODAL -->
    <div class="modal" id="addModal">
        <div class="modal-box">
            <h3 style="color:var(--text-main); font-family:'JetBrains Mono'">NEW TARGET</h3>
            <div id="step1">
                <input type="number" class="input-cyber" id="phoneInput" placeholder="628xxx (Ex: 628123456789)">
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-red" onclick="closeAddModal()">CANCEL</button>
                    <button class="btn btn-green" onclick="submitAddBot()">GET CODE</button>
                </div>
            </div>
            <div id="step2" class="hidden" style="text-align:center;">
                <p style="color:var(--cyan); font-size:12px; margin-top:10px;">PAIRING CODE:</p>
                <div id="pairingCodeDisplay" style="font-size:28px; font-weight:bold; color:var(--wa-green); margin:15px 0; letter-spacing:3px; font-family:'JetBrains Mono'">...</div>
                <button class="btn btn-red" style="width:100%" onclick="closeAddModal()">CLOSE</button>
            </div>
        </div>
    </div>

    <script>
        let selectedSession = null;
        let lastData = null;
        const startTime = Date.now();
        let pairingInterval = null;

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('id-ID', {hour12: false, hour:'2-digit', minute:'2-digit'});
            const diff = Math.floor((Date.now() - startTime) / 1000);
            const h = Math.floor(diff/3600);
            const m = Math.floor((diff%3600)/60);
            document.getElementById('statUptime').innerText = `${h}h ${m}m`;
        }, 1000);

        async function fetchStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                lastData = data;
                renderUI(data);
            } catch (e) {}
        }

        function renderUI(data) {
            document.getElementById('statTotal').innerText = data.sessions.length;
            document.getElementById('statActive').innerText = data.activeBots.length;
            document.getElementById('statOffline').innerText = data.sessions.length - data.activeBots.length;

            const grid = document.getElementById('botGrid');
            const currentHTML = data.sessions.map(s => {
                const isActive = data.activeBots.includes(s);
                const isSelected = selectedSession === s ? 'active' : '';
                return `
                    <div class="bot-card ${isActive ? 'online' : 'offline'} ${isSelected}" onclick="selectBot('${s}')">
                        <h3>+${s}</h3>
                        <span>${isActive ? 'ONLINE' : 'OFFLINE'}</span>
                    </div>
                `;
            }).join('');
            
            if (grid.innerHTML !== currentHTML) grid.innerHTML = currentHTML;
            updateTerminal(data);
        }

        function updateTerminal(data) {
            if (!selectedSession) return;
            document.getElementById('termTitle').innerText = `ROOT@${selectedSession}`;
            document.getElementById('termActions').style.display = 'block';

            const logs = data.logs[selectedSession] || [];
            const logContainer = document.getElementById('terminalLogs');
            
            if (logs.length === 0) {
                logContainer.innerHTML = '<div style="padding:10px; color:#555">No logs yet...</div>';
                return;
            }
            const html = logs.map(l => `<div class="log-entry ${l.type}"><span class="log-time">[${l.time}]</span><span class="log-msg">${l.msg}</span></div>`).join('');
            
            const shouldScroll = logContainer.scrollTop + logContainer.clientHeight >= logContainer.scrollHeight - 50;
            if (logContainer.innerHTML !== html) {
                logContainer.innerHTML = html;
                if (shouldScroll) logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        function selectBot(session) {
            selectedSession = session;
            if (lastData) renderUI(lastData);
        }

        async function controlBot(action) {
            if (!selectedSession) return;
            await fetch(`/api/${action}/${selectedSession}`, { method: 'POST' });
            if (action === 'delete') {
                selectedSession = null;
                document.getElementById('terminalLogs').innerHTML = '<div style="text-align:center; padding-top:100px; color:#333;">DELETED</div>';
                document.getElementById('termActions').style.display = 'none';
            }
            fetchStatus();
        }

        async function startAll() { await fetch('/api/start-all', { method: 'POST' }); fetchStatus(); }
        async function stopAll() { await fetch('/api/stop-all', { method: 'POST' }); fetchStatus(); }

        function openAddModal() { document.getElementById('addModal').style.display = 'flex'; document.getElementById('step1').classList.remove('hidden'); document.getElementById('step2').classList.add('hidden'); }
        function closeAddModal() { document.getElementById('addModal').style.display = 'none'; if(pairingInterval) clearInterval(pairingInterval); }

        async function submitAddBot() {
            const phone = document.getElementById('phoneInput').value;
            if (!phone) return alert('Masukkan Nomor!');
            const res = await fetch('/api/add', { method: 'POST', body: JSON.stringify({ phone }) });
            const data = await res.json();
            if (data.success) {
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                pairingInterval = setInterval(async () => {
                    const cRes = await fetch('/api/pairing-code/' + data.phone);
                    const cData = await cRes.json();
                    if (cData.code && cData.code !== 'WAITING') {
                        document.getElementById('pairingCodeDisplay').innerText = cData.code === 'CONNECTED' ? 'BERHASIL' : cData.code;
                        if(cData.code === 'CONNECTED') { clearInterval(pairingInterval); setTimeout(closeAddModal, 2000); fetchStatus(); }
                    }
                }, 2000);
            } else alert(data.message);
        }

        fetchStatus();
        setInterval(fetchStatus, 2000);
    </script>
</body>
</html>
