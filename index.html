<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0b141a">
    <title>WhatsApp Bot Connect</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ... (CSS yang sama seperti sebelumnya) ... */

        /* Tambah button start */
        .start-btn {
            background: linear-gradient(135deg, var(--wa-teal), var(--accent));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 10px 20px rgba(37, 211, 102, 0.3);
            transition: all 0.3s ease;
            display: none;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(37, 211, 102, 0.4);
        }

        .start-btn:active {
            transform: translateY(0);
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="avatar-wrapper fade-in">
            <div class="avatar-ring"></div>
            <div class="avatar">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/2044px-WhatsApp.svg.png" alt="Bot Avatar">
            </div>
        </div>

        <h1 class="fade-in" style="animation-delay: 0.1s">WhatsApp Panel</h1>
        <p class="subtitle fade-in" style="animation-delay: 0.2s" id="subtitle">Membuat koneksi aman ke server...</p>

        <div class="status-pill fade-in" style="animation-delay: 0.3s">
            <span class="dot" id="status-dot"></span>
            <span id="status">MENGINISIALISASI...</span>
        </div>

        <div class="progress-container fade-in" style="animation-delay: 0.4s">
            <div class="progress-fill" id="pfill"></div>
        </div>

        <!-- Button untuk start server -->
        <button class="start-btn fade-in" id="startServerBtn" style="animation-delay: 0.5s">
            ðŸš€ START SERVER
        </button>

        <div class="footer">Powered by WhatsApp Web API</div>
    </div>

    <script>
        const BIN_ID = '693151eed0ea881f40121ca6'; 
        const API_KEY = '$2a$10$u00Qvq6xrri32tc7bEYVhuQv94XS.ygeVCr70UDbzoOVlR8yLuUq.';
        const MAIN_URL = 'https://xgenzy.github.io/RVO/';
        const API_URL = 'http://localhost:3000/api/start'; // API untuk start server

        const statusText = document.getElementById('status');
        const statusDot = document.getElementById('status-dot');
        const pfill = document.getElementById('pfill');
        const subtitle = document.getElementById('subtitle');
        const startBtn = document.getElementById('startServerBtn');

        async function checkServer() {
            try {
                pfill.style.width = "20%";
                statusText.innerText = "MENCARI SESI...";
                
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': API_KEY }
                });
                
                pfill.style.width = "50%";
                
                if (!res.ok) throw new Error("Database Error");
                
                const data = await res.json();
                const targetUrl = data.record.url;

                if (!targetUrl || targetUrl.trim() === "") {
                    // Tidak ada URL di JSONBin, tampilkan button start
                    showStartButton();
                    return;
                }

                // Ada URL, lanjutkan ke TAHAP 2
                pfill.style.width = "85%";
                statusText.innerText = "MENYAMBUNGKAN...";
                
                setTimeout(() => {
                    pfill.style.width = "100%";
                    statusText.innerText = "BERHASIL!";
                    window.location.href = targetUrl;
                }, 800);

            } catch (e) {
                console.error(e);
                showStartButton();
            }
        }

        function showStartButton() {
            subtitle.innerText = "Server belum berjalan. Klik tombol di bawah untuk memulai.";
            statusText.innerText = "SERVER OFFLINE";
            statusDot.classList.add('error');
            pfill.style.width = "100%";
            pfill.style.background = "#ef5350";
            
            // Tampilkan button setelah 1 detik
            setTimeout(() => {
                startBtn.style.display = 'block';
            }, 1000);
        }

        async function startServer() {
            startBtn.disabled = true;
            startBtn.innerHTML = "â³ STARTING...";
            subtitle.innerText = "Memulai server, mohon tunggu...";
            statusText.innerText = "MEMULAI SERVER";
            statusDot.classList.remove('error');
            statusDot.classList.add('active');
            pfill.style.width = "0%";
            pfill.style.background = "linear-gradient(90deg, var(--wa-teal), var(--accent))";
            
            try {
                // Panggil API untuk start server
                const response = await fetch(API_URL);
                const result = await response.json();
                
                if (result.success) {
                    // Update progress
                    pfill.style.width = "70%";
                    statusText.innerText = "SERVER BERJALAN";
                    
                    // Tunggu 3 detik, lalu redirect
                    setTimeout(() => {
                        pfill.style.width = "100%";
                        statusText.innerText = "MENGARAHKAN...";
                        
                        setTimeout(() => {
                            window.location.href = result.url;
                        }, 1000);
                    }, 3000);
                } else {
                    throw new Error(result.error || 'Failed to start server');
                }
                
            } catch (error) {
                console.error('Failed to start server:', error);
                subtitle.innerText = "Gagal memulai server. Coba refresh halaman.";
                statusText.innerText = "GAGAL MEMULAI";
                statusDot.classList.remove('active');
                statusDot.classList.add('error');
                pfill.style.width = "100%";
                pfill.style.background = "#ef5350";
                
                // Reset button setelah 3 detik
                setTimeout(() => {
                    startBtn.disabled = false;
                    startBtn.innerHTML = "ðŸš€ COBA LAGI";
                }, 3000);
            }
        }

        // Event listener untuk button
        startBtn.addEventListener('click', startServer);

        // Check server saat page load
        window.onload = checkServer;
    </script>
</body>
</html>
